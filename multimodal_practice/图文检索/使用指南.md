# 🚀 Flickr8K 多模态检索系统 - 完整使用指南

## 📍 你现在的位置
✅ 数据已准备完成（8000张图像，40000条标注）
🎯 **下一步：训练模型**

## 🛤️ 完整流程（按顺序执行）

### 1️⃣ 训练双流编码器模型
```powershell
# 基础训练（推荐新手，快速完成）
C:\Users\rulea\Desktop\多模态QA\.conda\python.exe train_dual_encoder.py --epochs 5 --batch_size 16 --lr 1e-4 --device cpu

# 如果有GPU（效果更好）
C:\Users\rulea\Desktop\多模态QA\.conda\python.exe train_dual_encoder.py --epochs 20 --batch_size 64 --lr 1e-4 --device cuda
```

**训练完成后会生成：**
- `checkpoints/best.pth` - 最佳模型权重
- `data/vocab.json` - 词汇表文件

### 2️⃣ 构建检索索引
```powershell
# 为训练好的模型构建FAISS索引（用于快速检索）
C:\Users\rulea\Desktop\多模态QA\.conda\python.exe build_index.py --ckpt checkpoints/best.pth --index_dir indexes
```

**构建完成后会生成：**
- `indexes/` 目录包含FAISS索引文件

### 3️⃣ 使用模型的几种方式

#### 方式A：命令行推理
```powershell
# 文本→图像检索
C:\Users\rulea\Desktop\多模态QA\.conda\python.exe infer.py --mode t2i --query "a dog running in the park" --k 5

# 图像→文本检索
C:\Users\rulea\Desktop\多模态QA\.conda\python.exe infer.py --mode i2t --query "data/raw/Flicker8k_Dataset/某张图片.jpg" --k 5
```

#### 方式B：启动Web演示界面
```powershell
# 启动Gradio界面（推荐！直观易用）
C:\Users\rulea\Desktop\多模态QA\.conda\python.exe gradio_demo.py
```
然后访问：http://localhost:7860

#### 方式C：启动API服务
```powershell
# 启动FastAPI服务
C:\Users\rulea\Desktop\多模态QA\.conda\python.exe -m uvicorn api_server:app --host 0.0.0.0 --port 8000
```
然后访问：http://localhost:8000/docs

## 📊 预期效果

### 训练过程中你会看到：
```
Building vocabulary...
Vocabulary size: 2000+
Loading training data...
Loading validation data...
Starting training...
Epoch 1/5: 100%|████████| 250/250 [05:30<00:00, 0.75batch/s]
Train Loss: 0.8532, Val Loss: 0.7234, R@1: 15.2%, R@5: 35.6%
...
```

### 最终使用效果：
- **文本→图像**：输入"一只狗在公园跑步" → 返回5张最相关的狗狗图片
- **图像→文本**：上传狗狗照片 → 返回5句最相关的描述文字

## 🔧 故障排除

### 如果训练出错：
1. **内存不足**：减小batch_size到8或16
2. **找不到CUDA**：添加`--device cpu`
3. **导入错误**：确保在项目根目录运行

### 如果推理出错：
1. **模型文件不存在**：确保训练完成且checkpoints/best.pth存在
2. **索引文件不存在**：先运行build_index.py

## ⏱️ 时间估算

- **训练**：5 epochs约30分钟（CPU），10分钟（GPU）
- **构建索引**：约5分钟
- **推理**：每次查询1-2秒

## 🎯 快速开始命令

如果你想立即开始，复制这个命令：

```powershell
# 切换到项目目录并开始训练
cd "c:\Users\rulea\Desktop\多模态QA"
C:\Users\rulea\Desktop\多模态QA\.conda\python.exe train_dual_encoder.py --epochs 5 --batch_size 16 --lr 1e-4 --device cpu
```

训练完成后再运行后续步骤！
